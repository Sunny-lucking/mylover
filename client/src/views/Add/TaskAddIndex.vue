<template>
    <van-nav-bar title="Ê∑ªÂä†‰ªªÂä°" left-text="" left-arrow @click-left="onClickLeft" />
    <div class="page-container">
        <div class="content_addIndex">

            <van-swipe :autoplay="3000">
                <van-swipe-item v-for="image in images" :key="image">
                    <img :src="image" class="image-slider" alt="ÂïÜÂìÅÂõæÁâá" />
                </van-swipe-item>
            </van-swipe>

            <van-loading vertical v-if="isLoading" class="loading-overlay">
                <template #icon>
                    <van-icon name="star-o" size="30" />
                </template>
                Âä†ËΩΩ‰∏≠...
            </van-loading>

            <van-form class="form-container">
                <div>
                    <meta name="viewport"
                        content="width=device-width, initial-scale=1.0, minimum-scale=1.0, maximum-scale=1.0,user-scalable=no" />
                    <!-- <van-field label="üîñÈÄâÊã©È¢ÑËÆæ" v-model="presetIndex" :options="presets" @change="onPresetChange($event)" /> -->
                    <van-field v-model="presetIndex" is-link readonly label="üîñÈÄâÊã©È¢ÑËÆæ" placeholder="ÈÄâÊã©È¢ÑËÆæ"
                        @click="showPicker = true" />
                    <van-popup v-model:show="showPicker" round position="bottom ">
                        <van-picker :columns="columns" @cancel="showPicker = false" @confirm="onConfirm" clearable />
                    </van-popup>
                    <van-field label="üìå‰ªªÂä°ÂêçÁß∞" v-model="title" placeholder="ËØ∑ËæìÂÖ•‰ªªÂä°ÂêçÁß∞" :autofocus="false" clearable />
                    <van-field label="üìù‰ªªÂä°ËØ¶ÊÉÖ" v-model="desc" placeholder="ËØ∑ËæìÂÖ•‰ªªÂä°ËØ¶ÊÉÖ" type="textarea" rows="3"
                        :autofocus="false" clearable />
                    <van-field v-model="target_user.text" is-link readonly name="picker" label="ü§ñ‰ªªÂä°ÂØπË±°" placeholder="ÁÇπÂáªÈÄâÊã©‰ªªÂä°ÂØπË±°"
                        @click="showTargetPicker = true" />
                    <van-popup v-model:show="showTargetPicker" position="bottom">
                        <van-picker :columns="userColumns" @confirm="onConfirmTargetUser" @cancel="showTargetPicker = false" />
                    </van-popup>
                    <van-field label="üí∞ÁßØÂàÜ‰ª∑Ê†º" v-model="credit" placeholder="ËØ∑ËæìÂÖ•‰ªªÂä°ÂêçÁß∞" :autofocus="false" clearable />
                </div>
            </van-form>

            <div class="footer">
                <van-button class="btn-reset" type="default" @click="resetItem">ÈáçÁΩÆ</van-button>
                <van-button class="btn-save" type="primary" @click="saveItem">‰øùÂ≠ò</van-button>
            </div>
        </div>
    </div>
</template>

<script>
import { ref, onMounted, getCurrentInstance,reactive } from 'vue'; // Ê∑ªÂä†‰∫Ü onUnmounted
import axios from 'axios';
import png from '@/util/Mission.gif';
import { useRouter } from 'vue-router';
import { Field, Form, Button, Swipe, SwipeItem } from 'vant';
// Ëß£ÊûêJwt‰ª§Áâå
import jwtDecode from 'jwt-decode';

export default {
    components: {
        VanField: Field,
        VanForm: Form,
        VanButton: Button,
        VanSwipe: Swipe,
        VanSwipeItem: SwipeItem,
    },

    setup() {
        const { proxy } = getCurrentInstance();
        const isLoading = ref(false);
        const onClickLeft = () => history.back();
        const presetIndex = ref('Êó†È¢ÑËÆæ');
        const showPicker = ref(false);
        const title = ref('');
        const desc = ref('');
        let target_user = reactive({
            value:'',
            text: '',
        })
        const userColumns = ref([]);
        const showTargetPicker = ref(false);
        const credit = ref(0);

        const router = useRouter();
        const images = [png];
        onMounted(() => {
            fetchLoginToken();
            fetchUserData();
        });
        const token = localStorage.getItem('jwtToken'); // ‰ªélocalStorageËé∑ÂèñJWT‰ª§Áâå

        if (!token) {
            // router.push('/login');
        }
        console.log(token);
        const headers = {
            Authorization: `Bearer ${token}`
        };
        console.log(headers);
        let owner = ref(null);
        const fetchLoginToken = () => {

            const jwtToken = localStorage.getItem('jwtToken')
            console.log(jwtToken);
            const decodedToken = jwtDecode(jwtToken);
            // ‰ªéËß£Á†ÅÂêéÁöÑ‰ª§Áâå‰∏≠Ëé∑ÂèñÁâπÂÆöÁöÑÊï∞ÊçÆ
            owner.value = decodedToken; // ‰ªé‰ª§Áâå‰∏≠Ëé∑ÂèñÁî®Êà∑ID
            // Âú®ËøôÈáåÂ§ÑÁêÜÁôªÂΩï‰ª§ÁâåÊé•Âè£ÁöÑÂìçÂ∫î
            // Â¶ÇÊûúÈúÄË¶ÅÊâßË°å‰∏Ä‰∫õÁâπÂÆöÁöÑÊìç‰ΩúÔºåÂèØ‰ª•Âú®ËøôÈáåÊ∑ªÂä†‰ª£Á†Å

        };
        const fetchUserData = async () => {
            try {
                const response = await proxy.$http.get('/api/user/allUsers', { headers }); // ÊõøÊç¢‰∏∫ÂÆûÈôÖÁöÑAPIÁ´ØÁÇπ
                const userData = response.data.userList; // ÂÅáËÆæAPIËøîÂõû‰∏Ä‰∏™ÂåÖÂê´Áî®Êà∑Êï∞ÊçÆÁöÑÊï∞ÁªÑ
                // 2. Â∞ÜÁî®Êà∑Êï∞ÊçÆËΩ¨Êç¢‰∏∫ÈÄâÊã©Âô®ÁöÑÂàóÊ†ºÂºè
                userColumns.value = userData.map(user => ({
                    text: user.name,
                    value: user._id,
                }));
            } catch (error) {
                console.error('Ëé∑ÂèñÁî®Êà∑Êï∞ÊçÆÊó∂Âá∫Èîô', error);
            }
        };

        const onConfirmTargetUser = ({ selectedOptions }) => {
            target_user.value = selectedOptions[0].value;
            target_user.text = selectedOptions[0].text;
            
            showTargetPicker.value = false;
        };
        const columns = [
            { text: 'Êó†È¢ÑËÆæ', value: '0' },
            { text: 'Êó©Áù°Êó©Ëµ∑', value: '1' },
            { text: 'ÊâìÊâ´ÊàøÈó¥', value: '2' },
            { text: 'ÂÅ•Â∫∑ËøêÂä®', value: '3' },
            { text: 'ÊàíÁÉüÊàíÈÖí', value: '4' },
            { text: 'ËØ∑ÂÆ¢ÂêÉÈ•≠', value: '5' },
            { text: '‰π∞Â∞èÁ§ºÁâ©', value: '6' },
            { text: 'Ê¥óÁ¢óÊ¥óÁ¢ü', value: '7' },
            { text: 'Â∏ÆÊãø‰∏úË•ø', value: '8' },
        ];

        const onConfirm = ({ selectedOptions }) => {
            showPicker.value = false;
            presetIndex.value = selectedOptions[0].text;
            console.log(selectedOptions[0].value)
            onPresetChange(selectedOptions[0].text); // Ë∞ÉÁî® onPresetChange ÂáΩÊï∞ÔºåÊâãÂä®Ëß¶ÂèëÂÄºÂèòÂåñ
        };

        const onPresetChange = (value) => {
            // Ê†πÊçÆÈÄâÊã©ÁöÑÈ¢ÑËÆæÂÄºÊù•Ëá™Âä®Â°´ÂÖÖÂÖ∂‰ªñ‰ø°ÊÅØ
            if (value === 'Êó©Áù°Êó©Ëµ∑') {
                title.value = value;
                desc.value = 'ÁÜ¨Â§úÂØπË∫´‰ΩìÂæà‰∏çÂ•ΩÔºåËøòÊòØË¶ÅÊó©ÁÇπÁù°ËßâÁ¨¨‰∫åÂ§©ÊâçËÉΩÊúâÁ≤æÁ•ûÔºÅ';

            } else if (value === 'ÊâìÊâ´ÊàøÈó¥') {
                title.value = value;
                desc.value = 'Êúâ‰∏ÄÊÆµÊó∂Èó¥Ê≤°ÊúâÊâìÊâ´ÊàøÈó¥‰∫ÜÔºå‰∏ÄÂ±ã‰∏çÊâ´Ôºå‰Ωï‰ª•Êâ´Â§©‰∏ãÔºü';

            } else if (value === 'ÂÅ•Â∫∑ËøêÂä®') {
                title.value = value;
                desc.value = 'ÂÅö‰∏Ä‰∫õÂÅ•Ë∫´ËøêÂä®ÂêßÔºåË∑≥Áª≥ÔºåË∑ëÊ≠•ÔºåËÆ≠ÁªÉÂä®‰Ωú‰ªÄ‰πàÁöÑ„ÄÇ';

            } else if (value === 'ÊàíÁÉüÊàíÈÖí') {
                title.value = value;
                desc.value = 'Áª¥ÊåÅ‰∏ÄÊÆµÊó∂Èó¥‰∏çÂñùÈÖíÔºå‰∏çÊäΩÁÉüÔºå‰øùÊåÅÂÅ•Â∫∑ÁîüÊ¥ªÔºÅ';

            } else if (value === 'ËØ∑ÂÆ¢ÂêÉÈ•≠') {
                title.value = value;
                desc.value = 'Â•ΩÂêÉÁöÑÊúâÂæàÂ§öÔºåÊàëÂèØ‰ª•ËÆ©‰Ω†Â∞ùÂà∞ÂÖ∂‰∏≠‰πã‰∏ÄÔºåÂ•ΩÂ•Ω‰∫´ÂèóÂêßÔºÅ';

            } else if (value === '‰π∞Â∞èÁ§ºÁâ©') {
                title.value = value;
                desc.value = '‰π∞ÁÇπÂ∞èÁ§ºÁâ©ÔºåÂÉèÊ≥°Ê≥°È©¨Áâπ‰ªÄ‰πàÁöÑ„ÄÇ';

            } else if (value === 'Ê¥óÁ¢óÊ¥óÁ¢ü') {
                title.value = value;
                desc.value = 'ÊúâÊàëÊ¥óÁ¢óÊ¥óÁ¢üÂ≠êÔºåÊúâ‰Ω†ÂêÉÈ•≠Êó†ÂÆÉ‰∫ã„ÄÇ';

            } else if (value === 'Â∏ÆÊãø‰∏úË•ø') {
                title.value = value;
                desc.value = 'Êúâ‰∫ÜÊàëÔºå‰Ω†ÂÜç‰πü‰∏çÈúÄË¶ÅÁßªÂä®‰∫Ü„ÄÇÊãøÂ§ñÂçñÔºåÊãøÈõ∂È£üÔºåÂºÄÁ©∫Ë∞ÉÔºåÂºÄÁîµËßÜÔºåÂú®ÊâÄ‰∏çËæû„ÄÇ';

            }
        };


        const resetItem = () => {
            presetIndex.value = 'Êó†È¢ÑËÆæ'; // ÈÄâÊã©È¢ÑËÆæÁöÑÂÄºÈáçÁΩÆ‰∏∫0Ôºå‰ΩøÁî®.value
            title.value = ''; // ‰ªªÂä°ÂêçÁß∞ÈáçÁΩÆ‰∏∫Á©∫
            desc.value = ''; // ‰ªªÂä°ËØ¶ÊÉÖÈáçÁΩÆ‰∏∫Á©∫
            credit.value = 0; // ÁßØÂàÜ‰ª∑Ê†ºÈáçÁΩÆ‰∏∫0
            target_user = {}
        };

        const saveItem = () => {
            isLoading.value = true;
            // ÂáÜÂ§áË¶ÅÂèëÈÄÅÁöÑÊï∞ÊçÆÂØπË±°
            const updateTime = new Date();
            const registerTime = new Date();
            const task = {
                name: title.value,
                // ÂàõÂª∫‰∫∫ÁöÑid
                owner_id: owner.value._id,
                desc: desc.value,
                credit: credit.value,
                target_id: target_user.value,
                update_time: updateTime,
                create_time: registerTime

            };

            // ÂèëÈÄÅ POST ËØ∑Ê±ÇÂà∞ÊåáÂÆöÁöÑ URL
            proxy.$http.post('/api/task/add', task)
                .then(response => {
                    if (response.data.code === 0) {
                        // ËØ∑Ê±ÇÊàêÂäüÔºåÂèØ‰ª•Â§ÑÁêÜÊàêÂäüÁöÑÈÄªËæë
                        isLoading.value = false;
                        console.log('‰ªªÂä°Â∑≤‰øùÂ≠òÊàêÂäü');
                        router.push('/Task/1');
                    } else {
                        // ËØ∑Ê±ÇÂ§±Ë¥•ÔºåÂ§ÑÁêÜÈîôËØØÈÄªËæë
                        console.error('‰øùÂ≠ò‰ªªÂä°Â§±Ë¥•');
                    }
                })
                .catch(error => {
                    // ÊçïËé∑ÂºÇÂ∏∏
                    console.error('‰øùÂ≠ò‰ªªÂä°Êó∂Âá∫Áé∞ÈîôËØØ:', error);
                });
        };

        return {
            isLoading,
            columns,
            onConfirm,
            showPicker,
            presetIndex,
            title,
            desc,
            target_user,
            credit,
            resetItem,
            saveItem,
            onClickLeft,
            images,
            userColumns,
            onConfirmTargetUser,
            showTargetPicker,
        };
    },
};
</script>

<style scoped>
.page-container {
    display: flex;
    justify-content: center;
    /* align-items: center; */
    height: 100%;
    width: 100%;
    overflow-y: hidden;
    /* ÊòæÁ§∫ÂûÇÁõ¥ÊªöÂä®Êù° */
    overflow-x: hidden;
    /* ÈöêËóèÊ∞¥Âπ≥ÊªöÂä®Êù° */
    zoom: 1;
    /* Á¶ÅÊ≠¢È°µÈù¢ÂÜÖÂÆπÁº©Êîæ */
}

.content_addIndext {
    padding: 20px;
    max-width: 100%;
    max-height: 80%;
    overflow-y: auto;
    /* ÊòæÁ§∫ÂûÇÁõ¥ÊªöÂä®Êù° */
    overflow-x: hidden;
    /* ÈöêËóèÊ∞¥Âπ≥ÊªöÂä®Êù° */
}

.image-slider {
    width: 100%;
    height: 250px;
    object-fit: cover;
}

.form-container {
    margin-top: 20px;
}

.footer {
    display: flex;
    justify-content: space-between;
    margin-top: 20px;
}

.content_addIndex {
    width: 90%;
}

.btn-reset {
    flex: 1;
    margin-right: 10px;
}

.btn-save {
    flex: 1;
    margin-left: 10px;
}

.bottom-tabbar {
    position: fixed;
    bottom: 0;
    width: 100%;
    background-color: #fff;
    border-top: 1px solid #ccc;
}
</style>
